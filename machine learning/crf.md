# 条件随机场

在序列标注问题中，我们需要一个能利用丰富上下文特征建模全局上下文依赖的问题，而crf(conditional random field)正好解决了这个问题

## 无向图中的团与最大团

在条件随机场中，使用无向图构建依赖关系，节点v表示表示观测序列的节点，边e表示节点之间的依赖关系

无向图中的团是两两相连构建的集合，最大团指的是无法找到新节点与团内所有节点两两相连的团

根据 Hammersley–Clifford 定理， MRF 的联合概率可以分解为所有最大团的势函数的乘积，而 CRF 就是带条件的 MRF ，所以他同样可以时使用这一定理
假设$t_k$是边上的特征函数，称作转移特征，依赖于当前逾期按一个位置和前一个位置的状态，$s_l$ 是节点的特征函数，依赖于当前位置的观测值，他们都依赖于位置，所以是局部特征函数，他们的值为0或1，即表示是否，满足条件为1，不满足为0，他们的权值分别为$\alpha_k, \mu_l$
$$
P(Y|X) = \frac{1}{Z(X)} \prod_{C \in \text{MaxCliques}(G)} \psi_C(Y_C, X) \\
= \frac{1}{Z(X)} \exp(\sum_{i,k}\lambda_k t_k(y_{i-1}, y_i, X, i) + \sum_{i,l}\mu_l s_l(y_i, X, i))
$$
其中
$$
Z(X) = \sum_{Y} \exp(\sum_{i,k}\lambda_k t_k(y_{i-1}, y_i, X, i) + \sum_{i,l}\mu_l s_l(y_i, X, i))
$$
为什么要使用最大团来表示联合概率，因为如果使用传统方式用状态表示联合状态的话，那么K种状态就会得到$K^n$种组合，直接这样做会导致参数爆炸，无法泛化，所以我们利用无向图来做，考虑点之间的局部依赖关系，只让图中有边相连的变量彼此影响。
$$
P(Y_i \mid X,Y1,Y2,...Y_{i-1},Y_{i+1},...,Y_n) = P(Y_i \mid X,Y_{i-1},Y_{i+1})
$$
该式就表达了这种依赖关系，即当前状态只依赖于前一个状态和后一个状态，而不依赖于其他状态

## 链式化

在很多场景中，我们需要将CRF模型链式化，即每个状态只依赖于前一个状态和后一个状态，而不依赖于其他状态，这样可以减少参数数量，提高模型的效率。这种模型往往使用在序列标注中，例如词性标注、命名实体识别等。

## 前向后向算法求联合概率

像在HM中一样，我们使用前向后向算法来避免直接计算的时间问题，前向算法计算从开始到当前时间步的联合概率，后向算法计算从当前时间步到结束的联合概率，最后将这两个概率相乘即可得到联合概率。
其中前向算法起始向量$\alpha_i(x)$为：
$$
\alpha_0(y \mid x) = \begin{cases}
            1 &, y=start \\
            0 &, 否则
        \end{cases}
$$
递推公式为：
$$
\alpha_i^T(y_i \mid x) = \alpha_{i-1}^T(y_{i-1} \mid x) (M_i(y_{i-1}, y_i \mid x))
$$
这里的M是状态转移矩阵，$M_i(y_{i-1}, y_i \mid x)$ 表示从 $y_{i-1}$ 到 $y_i$ 的转移概率，即 $P(y_i \mid y_{i-1}, x)$ ，$M_i$ 是一个 $|Y| \times |Y|$ 的矩阵，$|Y|$ 是状态的数量。