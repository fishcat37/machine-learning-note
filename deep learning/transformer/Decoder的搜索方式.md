# 贪婪搜索

**在每一步都选择概率最大的 token** ，而不是考虑未来的全局最优。

✅ **优点**：

- 算法简单，速度快（复杂度低）。
- 不需要维护候选序列，只要保存当前生成的 token 即可。

❌ **缺点**：

- 只考虑局部最优，不考虑长远效果，容易错过更优解。例如在翻译任务中，某个词在当前位置最优，但会导致后续句子变差。
- 生成的文本容易 **单调/重复**，缺少多样性。

# 集束搜索

在每一步 保留多个候选序列（beam），避免过早陷入局部最优。

### 步骤：

- **第一步预测**

  - 输入 `<bos>`
  - 模型输出整个词表的概率分布
  - 取 **前 k 个概率最大的 token** → 初始 k 条序列
  - 每条序列的累积概率 = 单步概率
- **第二步及以后**

  - **每条序列独立预测**下一个 token → 得到自己的概率分布
  - 每条序列扩展 V 条候选 → 总候选 = k × V 条
  - 每条候选的 **累积概率 = 父序列累积概率 × 当前 token 概率(这里只考虑自己序列在该步的token概率，不考虑其他序列在该步的token概率)**
- **筛选**

  - 从 k × V 条候选中选出 **全局累积概率最大的 k 条(直接对所有累计概率进行全局排名取前k个，也就是说原本在beam中的一个序列可能因为后续累计概率低被淘汰)** → 下一轮 beam
  - 这样保持 beam size = k
- **循环**

  - 重复扩展 → 筛选 → 保留前 k 条
  - 直到生成 `<eos>` 或达到最大长度
- **输出**

  - 所有完成的序列中，取 **累积概率最大的序列**作为最终输出
  - 也可以取 top-k 完成序列作为 n-best 输出

✅ **优点**

- 比贪婪搜索更接近全局最优，避免了一些局部选择的陷阱。
- 生成的文本通常更流畅、合理。

❌ **缺点**

- 计算量是贪婪搜索的 **k 倍**。
- Beam size 太大时，结果可能趋同，文本缺乏多样性。
- 常常会偏向生成短句，所以需要 **长度惩罚 (Length Normalization)** 来平衡。

# 对抗搜索

对抗搜索的关键思想：

$\text{score}(y_t) = \underbrace{\log P(y_t \mid y_{<t})}_{\text{流畅性}} - \alpha \cdot \underbrace{\text{similarity}(y_t, \text{prefix})}_{\text{多样性惩罚}}$

- **流畅性**：下一个 token 的概率越高越好
- **多样性惩罚**：避免生成与已有序列太相似的 token
- 参数 α\\alphaα 控制平衡

换句话说，**不是只选择概率最大 token，而是选择在概率高且与已有序列不重复 / 不相似的 token**。

假设生成序列 y1:t−1y\_{1:t-1}y1:t−1：

1. **模型预测**：计算下一个 token 的概率分布 P(yt∣y<t)P(y\_t \\mid y\_{<t})P(yt∣y<t)
2. **计算对比分数**：

   - 流畅性：log⁡P(yt∣y<t)\\log P(y\_t \\mid y\_{<t})logP(yt∣y<t)
   - 多样性：与已有序列 embedding 的相似度 penalty
   - 最终 score = 流畅性 - α × 相似度
3. **选择 token**：取 score 最高的 token
4. **循环**：生成下一个 token
5. **终止条件**：生成 `<eos>` 或达到最大长度

**优点**：

- 平衡 **生成质量**（流畅性）和 **多样性**（避免重复）
- 不需要大 beam size，就能生成较自然文本
- 在长文本生成任务（故事、对话）中效果很好

❌ **缺点**：

- 需要计算 token embedding 相似度 → 计算量稍大
- 相比 greedy 速度略慢
- 对 α 参数敏感，需要调参

# Top-k 采样

为保证生成结果的多样性，需要对模型输出的概率分布进行采样，然后不加限制的采样会导致模型输出较差，Top-k采样就是只保留概率最高的k个token在这中间按分布采样

- 只保留概率最高的 k 个 token（Top-k）
- 在这 k 个 token 中按概率分布随机采样

**优点**：

- 保留生成概率高的候选 → 避免生成概率极低的“怪异” token
- 增加多样性 → 不像贪婪总是固定生成最优 token
- 简单易用，参数就是 k

❌ **缺点**：

- k 太小 → 行为接近贪婪 → 多样性低
- k 太大 → 可能采到低概率 token → 生成质量下降

# 对比

| 方法             | 流畅性 | 多样性 | 速度   |
| ---------------- | ------ | ------ | ------ |
| Greedy           | 高     | 低     | 快     |
| Beam Search      | 高     | 中     | 中     |
| Sampling (Top-k) | 中     | 高     | 中     |
| Contrastive      | 高     | 高     | 中偏慢 |
